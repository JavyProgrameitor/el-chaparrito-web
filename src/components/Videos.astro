---
const vids = [
  { label: "Cosecha de cereal", youtubeId: "n8XVYyIbnDQ", poster: "/posters/poster-cereal.jpg" },
  { label: "Cosecha de tomate", youtubeId: "KeMcqzyPPS0", poster: "/posters/poster-tomate.jpg" },
  { label: "Siembra",          youtubeId: "X1Iwf6DS-LE", poster: "/posters/poster-siembra.jpg" },
  { label: "Cosecha de maíz",  youtubeId: "Je6a-oadxa8", poster: "/posters/poster-maiz.jpg" },
];
---

<section class="py-10 px-4">
  <div class="text-center mx-auto max-w-5xl font-bold">
      <h2 class="text-3xl font-display sm:text-4xl">Vídeos de trabajos</h2>

    <div class="mt-6 grid gap-4 sm:grid-cols-2">
      {vids.map((v) => (
        <figure class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm transition hover:shadow-md">
          <figcaption class="px-4 pt-4 pb-3 font-semibold">{v.label}</figcaption>

          <div class="relative aspect-video bg-black">
            <button
              type="button"
              class="yt-open group absolute inset-0 block h-full w-full"
              data-id={v.youtubeId}
              aria-label={"Reproducir " + v.label}
            >
              <img
                src={v.poster}
                alt={v.label}
                loading="lazy"
                class="absolute inset-0 h-full w-full object-cover"
              />

              <div class="absolute inset-0 bg-black/20 transition group-hover:bg-black/30"></div>

              <div class="absolute inset-0 grid place-items-center">
                <div class="grid h-16 w-16 place-items-center rounded-full bg-white/90 shadow-md transition group-hover:scale-105">
                  <div class="ml-1 h-0 w-0 border-y-[10px] border-y-transparent border-l-[16px] border-l-black"></div>
                </div>
              </div>
            </button>
          </div>
        </figure>
      ))}
    </div>
  </div>
</section>

<!-- MODAL (una sola vez) -->
<div
  id="video-modal"
  class="fixed inset-0 z-50 hidden bg-black/80"
  aria-hidden="true"
>
  <!-- Contenedor grande del modal -->
  <div class="relative mx-auto h-[110vh] w-[min(1100px,92vw)] overflow-hidden rounded-2xl bg-jd-green shadow-xl">
    <!-- Máscara superior (tapa avatar/título) -->
    <div class="pointer-events-none absolute left-0 top-0 z-10 h-32 w-full bg-black"></div>

    <!-- Botón cerrar -->
    <button
      id="video-close"
      type="button"
      class="absolute right-3 top-3 z-20 rounded-full bg-white/90 px-3 py-2 text-sm font-semibold text-black hover:bg-white"
    >
      Cerrar ✕
    </button>

    <!-- Player ocupa TODO el contenedor -->
    <div class="absolute inset-0 bg-jd-yellow" id="video-player"></div>
  </div>
</div>

<script>
  function openModal(videoId: string) {
    const modal = document.getElementById("video-modal");
    const player = document.getElementById("video-player");
    if (!modal || !player) return;

    modal.classList.remove("hidden");
    modal.classList.add("block");
    modal.setAttribute("aria-hidden", "false");

    // iframe a pantalla completa dentro del contenedor
    player.innerHTML = `
      <iframe
        src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1"
        title="YouTube video player"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
        style="position:absolute; inset:0; width:100%; height:100%; border:0;"
      ></iframe>
    `;

    // Bloquear scroll del body (opcional pero queda pro)
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    const modal = document.getElementById("video-modal");
    const player = document.getElementById("video-player");
    if (!modal || !player) return;

    player.innerHTML = "";
    modal.classList.add("hidden");
    modal.classList.remove("block");
    modal.setAttribute("aria-hidden", "true");

    document.body.style.overflow = "";
  }

  document.addEventListener("click", (event) => {
    const target = event.target;
    if (!(target instanceof Element)) return;

    const openBtn = target.closest(".yt-open");
    if (openBtn) {
      const id = openBtn.getAttribute("data-id");
      if (id) openModal(id);
      return;
    }

    if (target.id === "video-close") {
      closeModal();
      return;
    }

    // Cerrar clicando fuera del contenedor (sobre el fondo)
    if (target.id === "video-modal") {
      closeModal();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });
</script>
